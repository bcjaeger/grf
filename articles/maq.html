<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qini curves: Automatic cost-benefit analysis • grf</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Qini curves: Automatic cost-benefit analysis">
<meta property="og:description" content="grf">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">grf</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.3.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/grf.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/grf_guide.html">A grf guided tour</a>
    </li>
    <li>
      <a href="../articles/rate.html">Assessing heterogeneity with RATE</a>
    </li>
    <li>
      <a href="../articles/categorical_inputs.html">Categorical covariates</a>
    </li>
    <li>
      <a href="../articles/survival.html">Causal forest with time-to-event data</a>
    </li>
    <li>
      <a href="../articles/ate_transport.html">Estimating ATEs on a new target population</a>
    </li>
    <li>
      <a href="../articles/muhats.html">Estimating conditional means</a>
    </li>
    <li>
      <a href="../articles/diagnostics.html">Evaluating a causal forest fit</a>
    </li>
    <li>
      <a href="../articles/llf.html">Local linear forests</a>
    </li>
    <li>
      <a href="../articles/policy_learning.html">Policy learning via optimal decision trees</a>
    </li>
    <li>
      <a href="../articles/maq.html">Qini curves: Automatic cost-benefit analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="../REFERENCE.html">Algorithm reference</a>
</li>
<li>
  <a href="../DEVELOPING.html">Developing</a>
</li>
<li>
  <a href="../CHANGELOG.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/grf-labs/grf">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="maq_files/header-attrs-2.25/header-attrs.js"></script><script src="maq_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Qini curves: Automatic cost-benefit analysis</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/grf-labs/grf/blob/master/vignettes/maq.Rmd"><code>vignettes/maq.Rmd</code></a></small>
      <div class="hidden name"><code>maq.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">grf</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">maq</span>)</pre></body></html></div>
<p>This vignette gives a brief overview of how Qini curves (or cost curves) can act as an attractive and intuitive metric for evaluating treatment rules when there are costs associated with deploying treatment, as well as how they can be generalized to many treatment arms, as implemented in the companion package <a href="https://github.com/grf-labs/maq">maq</a>. For complete details, we refer to <a href="https://arxiv.org/abs/2306.11979">this paper</a>.</p>
<p>The <a href="#cate-evaluation-as-a-policy-evaluation-exercise">first section</a> of this vignette recaps evaluation metrics for treatment effect estimators. The <a href="#evaluation-metrics-when-treatment-assignment-is-costly">second section</a> introduces Qini curves for when treatment assignment has associated costs, and the <a href="#qini-curves-with-multi-armed-treatment">third section</a> covers how Qini curves can be generalized to multiple treatment arms.</p>
<div id="cate-evaluation-as-a-policy-evaluation-exercise" class="section level2">
<h2 class="hasAnchor">
<a href="#cate-evaluation-as-a-policy-evaluation-exercise" class="anchor"></a>CATE evaluation as a policy evaluation exercise</h2>
<p>Before jumping into Qini curves, let’s start by defining some terminology and refreshing some concepts. Consider a binary treatment assignment <span class="math inline">\(W_i = \{0, 1\}\)</span> and some outcome of interest <span class="math inline">\(Y_i\)</span>. In order to determine if there are certain subgroups of the population, as defined by some observable characteristics <span class="math inline">\(X_i\)</span>, that benefit differently from the treatment assignment, a central object of interest is the conditional average treatment effect (CATE)</p>
<p><span class="math display">\[\tau(X_i) = E[Y_i(1) - Y_i(0) \,|\, X_i = x],\]</span></p>
<p>where <span class="math inline">\(Y(1)\)</span> and <span class="math inline">\(Y(0)\)</span> are potential outcomes corresponding to the two treatment states: treatment or control arm.</p>
<p>There are many approaches to obtain estimates of the function <span class="math inline">\(\tau(X_i)\)</span>, <em>Causal Forest</em> being one of them. Now, once we an estimated <span class="math inline">\(\hat \tau(\cdot)\)</span> function, or set of functions, what <em>metric</em> can we use to evaluate them with? Recall that, as opposed to a classical prediction problem, we never observe ground truth treatment effects, so we cannot use a held-out test sample to compute something like a mean squared prediction error <span class="math inline">\(E[(f(X_i) - Y_i)^2]\)</span>.</p>
<p>A metric we propose for this purpose is called the <a href="https://grf-labs.github.io/grf/reference/rank_average_treatment_effect.html">RATE</a> and is covered in <a href="https://grf-labs.github.io/grf/articles/rate.html">this vignette</a>. With RATE we take a <em>policy evaluation</em> approach to guide the construction of a metric: assume we have obtained an estimated CATE function <span class="math inline">\(\hat \tau(\cdot)\)</span> on some <em>training set</em> and on a held-out <em>test set</em> <span class="math inline">\(X_{test}\)</span> we have observed outcomes <span class="math inline">\(Y_i(W_i)\)</span> for people who were treated, or not treated.</p>
<p>The estimated CATE function <span class="math inline">\(\hat \tau(\cdot)\)</span> induces a family of <em>policies</em>, which we refer to as <span class="math inline">\(\hat \pi(\cdot)\)</span>, that takes covariates <span class="math inline">\(X_i\)</span> and maps them to a treatment decision <span class="math inline">\(\{0: \text{don't treat}, 1: \text{treat}\}\)</span>. For example, on the held-out test set, the predictions <span class="math inline">\(\hat \tau(X_{test})\)</span> implicitly tell us that a reasonable policy to determine treatment allocation with is: “If the estimated CATE for Alice is highest, then treat Alice first”, and “If the estimated CATE for Bob is the second highest, then treat Bob second”, and so on.</p>
<p>The policy we just described can be more aptly termed a <em>prioritization rule</em>. The estimated CATEs implicitly tell us how to <em>prioritize</em> treatment allocation on a test set by following a simple <em>rule</em>: First treat Alice, then Bob, and so on, in order of decreasing CATE estimates. Recall that we have access to Bob and Alice’s observed outcomes <span class="math inline">\(Y_i(W_i)\)</span> on the test set, so we can evaluate the quality of this “predicted” policy by appropriately calculating some measure of agreement between <span class="math inline">\(\hat \tau(X_{test})\)</span> and <span class="math inline">\(Y_i(W_i)\)</span>, i.e., do the people our CATE estimator give high priority to also have high average treatment effects as (appropriately) measured by their observed outcomes <span class="math inline">\(Y_i(W_i)\)</span>? (for the purpose of this simple vignette we are assuming the treatment is randomly assigned, so that we can compute average treatment effects as simple differences in observed outcomes, the next section gives more detail, for complete details we refer to the papers listed in the references).</p>
<p>A first ingredient of RATE is to essentially take the estimated <span class="math inline">\(\hat \tau(\cdot)\)</span>, treat it as a prioritization rule, then on the test set trace out the estimated average treatment effect (ATE) of people included in the rule minus the whole sample ATE, as we descend down the rule list “Alice, Bob, etc”. We refer to this curve as the <em>TOC</em> curve. As mentioned in the <a href="https://grf-labs.github.io/grf/articles/rate.html">RATE</a> vignette this is a visually appealing way to assess how a CATE estimator (or any other scoring rule wish to employ for treatment targeting) performs on a held-out test set. A second ingredient of a RATE is then to collapse this curve to a single point estimate, via computing an area under the curve (AUC), similar to how the area under the “ROC” curve can be used to assess a binary classifier.</p>
<p>This approach to evaluation can essentially be summarized as follows:</p>
<ul>
<li>A CATE estimator (causal forest, X-learner, stacked R-learner, etc) gives you an estimated function <span class="math inline">\(\hat \tau (\cdot)\)</span>.</li>
<li>This CATE function “induces” a policy <span class="math inline">\(\hat \pi\)</span> that you can evaluate on a test set by plotting a TOC curve.</li>
<li>The RATE is a metric that can be used to quantify the value of this policy on a test set.</li>
</ul>
<p>The appeal of this construction is that it enables you to transparently answer questions like “Did my estimated CATE function manage to detect treatment effect heterogeneity”, or “Which of these estimated CATE functions performs best” - by conducting simple evaluation exercises on a held-out test set.</p>
</div>
<div id="evaluation-metrics-when-treatment-assignment-is-costly" class="section level2">
<h2 class="hasAnchor">
<a href="#evaluation-metrics-when-treatment-assignment-is-costly" class="anchor"></a>Evaluation metrics when treatment assignment is costly</h2>
<p>Consider now the case where assigning treatment incurs a cost, where we let <span class="math inline">\(C_i(1)\)</span> denote the cost of assigning unit <span class="math inline">\(i\)</span> the treatment arm (and assume that withholding treatment is costless, <span class="math inline">\(C_i(0)=0\)</span>). An example where costs may vary by unit could be in administering vaccines: getting medicines to people who live very far away from healthcare centers is likely more costly than getting medicines to people who live close by. Costs does not have to be monetary, they could also capture something more abstract, such as negative externalities.</p>
<p>The question we now ask is, given a budget <span class="math inline">\(B\)</span>, what is a suitable approach to quantify the cost-benefit tradeoff of assigning treatment in accordance with our estimated CATEs? It turns out that incorporating costs into the policy evaluation framework we outlined in the previous section is straightforward - but the curve is going to capture something different than the TOC.</p>
<p>Recall the policy <span class="math inline">\(\hat \pi(X_i)\)</span> is a function that maps covariates <span class="math inline">\(X_i\)</span> to a treatment decision, <span class="math inline">\(\hat \pi(X_i) \in \{0: \text{don't treat}, 1: \text{treat}\}\)</span>. In this section, this function will depend on the budget <span class="math inline">\(B\)</span> which we denote by the subscript <span class="math inline">\(\hat \pi_B(X_i)\)</span>. It turns out that this policy can be expressed, just as in the previous section, as a treatment prioritization rule that essentially says “If you have <span class="math inline">\(B\)</span> available to spend, then treat Alice first if her estimated cost-benefit ratio, CATE/cost is the highest”, and so on. If Alice’s estimated CATE is negative, we would not consider treating her, as we would incur a cost, but reduce our gain.</p>
<p>Just as before, we have available a test set with <span class="math inline">\(n\)</span> observed outcomes to perform evaluation on. We are interested in quantifying the expected <em>gain</em> (measured by the ATE) we can achieve by assigning treatment in accordance with <span class="math inline">\(\hat \pi_B\)</span> at different <em>spend</em> levels <span class="math inline">\(B\)</span>.</p>
<p>In the previous section we left out the exact details of how to <em>evaluate</em> a policy. Luckily, it turns out this is simple: if we know the treatment randomization probabilities, then we can use inverse-propensity weighting (IPW) to estimate the value of the gain we achieve through averaging the difference in test set outcomes that matches our policy prescription:</p>
<p><span class="math display">\[
\frac{1}{n} \sum_{i}^{n} \hat \pi_B(X_i) \left( \frac{W_i Y_i}{P[W_i = 1|X_i]} - \frac{(1-W_i)Y_i}{P[W_i = 0|X_i]} \right).
\]</span> IPW (the terms in parenthesis) accounts for the fact that the prescribed policy <span class="math inline">\(\hat \pi_B(X_i)\)</span> might not match the observed treatment <span class="math inline">\(W_i\)</span> for unit i. The <strong>Qini curve</strong> traces out the above value as we vary the available budget <span class="math inline">\(B\)</span>, yielding an estimate of</p>
<p><span class="math display">\[
Q(B) = E[\pi_B(X_i) (Y_i(1) - Y_i(0))] = E[\pi_B(X_i) \tau(X_i)],
\]</span> the gain we can achieve when assigning treatment in accordance with our <em>estimated</em> CATEs, and costs, at various values of the budget <span class="math inline">\(B\)</span>.</p>
<p>The following code example gives a toy example, where we to keep the exposition simple, assume each unit has the same cost, assigning treatment to both Bob and Alice costs 1.0, on some chosen denomination (a nice property of the Qini as an evaluation metric is that it does not require costs and treatment effects to be denominated on the same scale, only their ratio matters).</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">2000</span>
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fl">5</span>
<span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span> * <span class="no">p</span>), <span class="no">n</span>, <span class="no">p</span>)
<span class="no">W</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="no">n</span>, <span class="fl">1</span>, <span class="fl">0.5</span>)
<span class="no">Y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>(<span class="no">X</span>[, <span class="fl">1</span>], <span class="fl">0</span>) * <span class="no">W</span> + <span class="no">X</span>[, <span class="fl">2</span>] + <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span>(<span class="no">X</span>[, <span class="fl">3</span>], <span class="fl">0</span>) + <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span>)

<span class="co"># 1) Train a CATE function on training set.</span>
<span class="no">train</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="no">n</span>/<span class="fl">2</span>)
<span class="no">c.forest</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/causal_forest.html">causal_forest</a></span>(<span class="no">X</span>[<span class="no">train</span>, ], <span class="no">Y</span>[<span class="no">train</span>], <span class="no">W</span>[<span class="no">train</span>])

<span class="co"># 2) Predict CATEs on test set.</span>
<span class="no">test</span> <span class="kw">&lt;-</span> -<span class="no">train</span>
<span class="no">tau.hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">c.forest</span>, <span class="no">X</span>[<span class="no">test</span>, ])$<span class="no">predictions</span>

<span class="co"># 3) Estimate a Qini curve using inverse-propensity weighted test set outcomes.</span>
<span class="no">IPW.scores</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">W</span>[<span class="no">test</span>] <span class="kw">==</span> <span class="fl">1</span>, <span class="no">Y</span>[<span class="no">test</span>]/<span class="fl">0.5</span>, -<span class="no">Y</span>[<span class="no">test</span>]/<span class="fl">0.5</span>)
<span class="co"># Assume each unit incur the same cost.</span>
<span class="no">cost</span> <span class="kw">&lt;-</span> <span class="fl">1</span>
<span class="co"># Use the maq package to fit a Qini curve, using 200 bootstrap replicates for SEs.</span>
<span class="no">qini</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/maq/man/maq.html">maq</a></span>(<span class="no">tau.hat</span>, <span class="no">cost</span>, <span class="no">IPW.scores</span>, <span class="kw">R</span> <span class="kw">=</span> <span class="fl">200</span>)

<span class="co"># Form a baseline Qini curve that uses the ATE rather than the CATE to assign treatment.</span>
<span class="no">qini.baseline</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/maq/man/maq.html">maq</a></span>(<span class="no">tau.hat</span>, <span class="no">cost</span>, <span class="no">IPW.scores</span>, <span class="kw">target.with.covariates</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">R</span> <span class="kw">=</span> <span class="fl">200</span>)

<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">qini</span>, <span class="kw">xlim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">1</span>))
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">qini.baseline</span>, <span class="kw">add</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">ci.args</span> <span class="kw">=</span> <span class="kw">NULL</span>) <span class="co"># leave out CIs for legibility.</span></pre></body></html></div>
<p><img src="maq_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>The solid curve shows the expected gain (y-axis) as we assign treatment to units predicted to benefit the most per unit spent, as we increase the amount we are willing to spend per unit (x-axis), along with 95 % confidence bars. The dashed line shows the Qini curve when we assign treatment without considering the CATE, i.e., at the end of this line, at which point we have exhausted the budget and given everyone the treatment, our gain is equal to the ATE of around 0.38. (So, points on the dashed-line represent the fraction of the ATE we can expect when targeting an arbitrary group of the population at different spend levels, thus it does not have to be a 45-degree line)</p>
<p>The solid black curve is the Qini curve that uses the estimated CATEs to predict which test set subjects have the highest treatment effect per unit spent. As this curve rises sharply above the dashed straight line that “ignores” the CATE, it suggests there is a benefit to targeting treatment to a subpopulation as implied by the estimated CATEs, that is most responsive per unit spent. This curve stops (or “plateaus”) at <span class="math inline">\(B=\)</span> 0.88 because at that point we have assigned treatment to the units predicted to benefit, <span class="math inline">\(\hat \tau(X_i) &gt; 0\)</span>.</p>
<p>We can read off estimates on the curve at various <span class="math inline">\(B\)</span> through</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/maq/man/average_gain.html">average_gain</a></span>(<span class="no">qini</span>, <span class="kw">spend</span> <span class="kw">=</span> <span class="fl">0.2</span>)
<span class="co">#&gt; estimate  std.err </span>
<span class="co">#&gt;    0.301    0.045</span></pre></body></html></div>
<p>That is, at an average spend of <span class="math inline">\(B=0.2\)</span> a 95% confidence interval for the average benefit per unit is 0.3 <span class="math inline">\(\pm\)</span> 0.09. (these standard errors are conditional on the estimated function <span class="math inline">\(\hat \tau(\cdot)\)</span> and quantify test set uncertainty in estimating the Qini curve).</p>
<p>Had we instead used the same amount of budget to treat an arbitrary group of the population, our estimated gain would be</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/maq/man/average_gain.html">average_gain</a></span>(<span class="no">qini.baseline</span>, <span class="kw">spend</span> <span class="kw">=</span> <span class="fl">0.2</span>)
<span class="co">#&gt; estimate  std.err </span>
<span class="co">#&gt;    0.075    0.019</span></pre></body></html></div>
<p><em>Note on policy evaluation:</em> whenever IPW can solve a problem, there is generally a doubly robust method (here Augmented-IPW) that can do better in terms of statistical power. In this vignette, we’ll stick to evaluating with IPW for simplicity, but note that with GRF you could train a separate test set forest and retrieve doubly robust test set scores through the function <code><a href="../reference/get_scores.html">get_scores(forest)</a></code> that could be used in place of <code>IPW.scores</code>, yielding a doubly robust estimate of the Qini curve.</p>
<div id="aside-the-qini-curve-vs-the-toc-curve" class="section level3">
<h3 class="hasAnchor">
<a href="#aside-the-qini-curve-vs-the-toc-curve" class="anchor"></a>Aside: The Qini curve vs the TOC curve</h3>
<p>We have thus far introduced <em>two curves</em> that may seem to both serve a similar purpose. What’s the difference? That depends on the application. If we look closer, which of these curves is useful depends on what questions we are interested in. Below is a side-by-side illustration of what the <a href="https://grf-labs.github.io/grf/articles/rate.html#quantifying-treatment-benefit-the-targeting-operator-characteristic-1">TOC</a> and Qini curves could look like in the case the ATE is positive, but there are subgroups of people with both positive and negative treatment effects (the dashed line in the Qini plot represent the ATE). <img src="maq_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>The TOC compares an average treatment effect over the quantiles of some scoring rule to the overall average treatment effect. The Qini curve quantifies an average treatment effect per unit as we vary a budget constraint on spend per unit.</p>
<p>So: The TOC curve is useful if you are in a setting where you are interested in whether there is a group of people that benefit more than average from being treated. If costs are not directly relevant, and you are more interested in detecting the presence of heterogeneity, then the TOC is helpful because it clearly reveals the quantile where targeting helps. The TOC thus serves as a general tool for measuring heterogeneity.</p>
<p>The Qini curve is useful if you are in a setting where it is natural to undertake some cost-benefit analysis. The Qini curve is helpful because it clearly reveals the expected gain you can achieve by targeting the most responsive units, per spend, at various levels of budget allocations available. Another benefit of the Qini curve is that it is also more natural to be extended to many treatment arms, as the cost element carries over a similar cost-benefit tradeoff, but now across both arms and units.</p>
<p><em>Note on constant costs:</em> For a single treatment arm, when each unit has the same cost <span class="math inline">\(C_i(X_i) = 1\)</span>, we can also interpret the x-axis on the Qini curve plot above as the treated fraction.</p>
</div>
</div>
<div id="qini-curves-with-multi-armed-treatment" class="section level2">
<h2 class="hasAnchor">
<a href="#qini-curves-with-multi-armed-treatment" class="anchor"></a>Qini curves with multi-armed treatment</h2>
<p>Consider now the case where we have <span class="math inline">\(k = 0,\ldots K\)</span> arms available, where <span class="math inline">\(k=0\)</span> is a zero cost control arm. For example, <span class="math inline">\(k=1\)</span> could be a low cost drug, and <span class="math inline">\(k=2\)</span> could be a higher cost drug, but which is more effective (and <span class="math inline">\(k=0\)</span> could be a placebo control).</p>
<p>Given estimated treatment effects <span class="math inline">\(\hat \tau(\cdot)\)</span>, and costs <span class="math inline">\(C(\cdot)\)</span> (remember that these objects are now vector-valued, i.e. the <span class="math inline">\(k\)</span>-th element of <span class="math inline">\(\hat \tau(X_i)\)</span> is an estimate of the CATE for arm <span class="math inline">\(k\)</span> for units with covariates <span class="math inline">\(X_i\)</span><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>) - we now ask: how can we conduct a similar exercise as above where we evaluate allocating treatment optimally in accordance with our estimated CATEs (and costs), as we vary the available budget?</p>
<p>It turns out that in order to perform this exercise, we need to solve a constrained optimization problem, as the underlying policy object <span class="math inline">\(\hat \pi_B(X_i)\)</span> now has to optimally select among many potential arms (with different costs) for each unit. For example, at each spend level, we have to decide whether we should allocate some <em>initial</em> arm to Alice, <em>or</em> perhaps, if Bob was already assigned an arm, if we instead should <em>upgrade</em> Bob to a costlier, but more effective arm.</p>
<p>The <a href="https://github.com/grf-labs/maq">maq</a> package performs this exercise efficiently (by computing a solution path via a tailored algorithm), and we’ll here jump straight into a toy example with 2 treatment arms and a control. We are simulating a simple example where one treatment arm (number 2) is more effective on average but costlier. We are imagining the cost of assigning any unit to the first arm is 0.2 (on some chosen denomination), and the cost of assigning each unit to the second arm is 0.5 (costs could also vary by units based on some known characteristics, in which case we could supply a matrix as the <code>cost</code> argument below).</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># Simulate two treatment arms (1 and 2) and a control arm 0.</span>
<span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">3000</span>
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fl">5</span>
<span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="no">n</span> * <span class="no">p</span>), <span class="no">n</span>, <span class="no">p</span>)
<span class="no">W</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"0"</span>, <span class="st">"1"</span>, <span class="st">"2"</span>), <span class="no">n</span>, <span class="kw">replace</span> <span class="kw">=</span> <span class="fl">TRUE</span>))
<span class="no">Y</span> <span class="kw">&lt;-</span> <span class="no">X</span>[, <span class="fl">1</span>] + <span class="no">X</span>[, <span class="fl">2</span>] * (<span class="no">W</span> <span class="kw">==</span> <span class="st">"1"</span>) + <span class="fl">1.5</span> * <span class="no">X</span>[, <span class="fl">3</span>] * (<span class="no">W</span> <span class="kw">==</span> <span class="st">"2"</span>) + <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span>)

<span class="co"># 1) Train a CATE function on training set.</span>
<span class="no">train</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="no">n</span>/<span class="fl">2</span>)
<span class="no">c.forest</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/multi_arm_causal_forest.html">multi_arm_causal_forest</a></span>(<span class="no">X</span>[<span class="no">train</span>, ], <span class="no">Y</span>[<span class="no">train</span>], <span class="no">W</span>[<span class="no">train</span>])

<span class="co"># 2) Predict CATEs on test set.</span>
<span class="no">test</span> <span class="kw">&lt;-</span> -<span class="no">train</span>
<span class="no">tau.hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">c.forest</span>, <span class="no">X</span>[<span class="no">test</span>, ], <span class="kw">drop</span> <span class="kw">=</span> <span class="fl">TRUE</span>)$<span class="no">predictions</span>

<span class="co"># 3) Form a multi-armed Qini curve based on IPW (convenience function part of `maq`).</span>
<span class="no">IPW.scores</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/maq/man/get_ipw_scores.html">get_ipw_scores</a></span>(<span class="no">Y</span>[<span class="no">test</span>], <span class="no">W</span>[<span class="no">test</span>])

<span class="co"># The cost of arm 1 and 2.</span>
<span class="no">cost</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.2</span>, <span class="fl">0.5</span>)

<span class="co"># A Qini curve for a multi-armed policy.</span>
<span class="no">ma.qini</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/maq/man/maq.html">maq</a></span>(<span class="no">tau.hat</span>, <span class="no">cost</span>, <span class="no">IPW.scores</span>, <span class="kw">R</span> <span class="kw">=</span> <span class="fl">200</span>)

<span class="co"># A "baseline" Qini curve that ignores covariates.</span>
<span class="no">ma.qini.baseline</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/maq/man/maq.html">maq</a></span>(<span class="no">tau.hat</span>, <span class="no">cost</span>, <span class="no">IPW.scores</span>, <span class="kw">target.with.covariates</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">R</span> <span class="kw">=</span> <span class="fl">200</span>)</pre></body></html></div>
<p>The Qini curves for a multi-armed policy looks like</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">ma.qini</span>)
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">ma.qini.baseline</span>, <span class="kw">add</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">ci.args</span> <span class="kw">=</span> <span class="kw">NULL</span>)</pre></body></html></div>
<p><img src="maq_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>The dashed line represents a Qini curve that allocates treatment to arms based only on the averages of <code>tau.hat</code>. This curve has a kink at <span class="math inline">\(B=0.2\)</span>: the first segment traces out the ATE of the lower cost arm, and the second segment the ATE of the higher cost but on the average more effective arm. Points on this curve represent the average benefit per unit when targeting an arbitrary group of units<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.</p>
<p>The solid line shows the estimated Qini curve for a policy that uses <code>tau.hat</code> and <code>cost</code> to assign the treatment arm to the unit that is predicted to be most cost-beneficial at a given spend. We can assess the value of targeting with both arms over randomly assigning treatment by estimating the difference between the dashed and solid lines. For example, at <span class="math inline">\(B=0.3\)</span>, this vertical distance is</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/maq/man/difference_gain.html">difference_gain</a></span>(<span class="no">ma.qini</span>, <span class="no">ma.qini.baseline</span>, <span class="kw">spend</span> <span class="kw">=</span> <span class="fl">0.3</span>)
<span class="co">#&gt; estimate  std.err </span>
<span class="co">#&gt;     0.23     0.05</span></pre></body></html></div>
<p>We can retrieve an estimate of the underlying multi-armed policy <span class="math inline">\(\pi_B\)</span> through <code>predict</code>, for example at <span class="math inline">\(B=0.3\)</span></p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">pi.hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">ma.qini</span>, <span class="kw">spend</span> <span class="kw">=</span> <span class="fl">0.3</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">pi.hat</span>)
<span class="co">#&gt;      [,1] [,2]</span>
<span class="co">#&gt; [1,]    1    0</span>
<span class="co">#&gt; [2,]    1    0</span>
<span class="co">#&gt; [3,]    1    0</span>
<span class="co">#&gt; [4,]    1    0</span>
<span class="co">#&gt; [5,]    0    1</span>
<span class="co">#&gt; [6,]    0    0</span></pre></body></html></div>
<p><span class="math inline">\(\pi_B(X_i)\)</span> is now a <span class="math inline">\(K\)</span>-dimensional vector, i.e. the <span class="math inline">\(i\)</span>-th row above has a 1 in the <span class="math inline">\(k\)</span>-th column if we at that spend level assign arm <span class="math inline">\(k\)</span> to that unit, with all entries zero if the control arm is assigned.<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a></p>
<p>We can also compare with single-armed treatment policies by computing Qini curves for each arm.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">qini.arm1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/maq/man/maq.html">maq</a></span>(<span class="no">tau.hat</span>[, <span class="fl">1</span>], <span class="no">cost</span>[<span class="fl">1</span>], <span class="no">IPW.scores</span>[, <span class="fl">1</span>], <span class="kw">R</span> <span class="kw">=</span> <span class="fl">200</span>)
<span class="no">qini.arm2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/maq/man/maq.html">maq</a></span>(<span class="no">tau.hat</span>[, <span class="fl">2</span>], <span class="no">cost</span>[<span class="fl">2</span>], <span class="no">IPW.scores</span>[, <span class="fl">2</span>], <span class="kw">R</span> <span class="kw">=</span> <span class="fl">200</span>)

<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">ma.qini</span>, <span class="kw">ci.args</span> <span class="kw">=</span> <span class="kw">NULL</span>) <span class="co"># leave out CIs for legibility.</span>
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">qini.arm1</span>, <span class="kw">add</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"blue"</span>, <span class="kw">ci.args</span> <span class="kw">=</span> <span class="kw">NULL</span>)
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">qini.arm2</span>, <span class="kw">add</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">ci.args</span> <span class="kw">=</span> <span class="kw">NULL</span>)
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">ma.qini.baseline</span>, <span class="kw">add</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">ci.args</span> <span class="kw">=</span> <span class="kw">NULL</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span>(<span class="st">"topleft"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"both arms"</span>, <span class="st">"arm 1"</span>, <span class="st">"arm 2"</span>),
       <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"black"</span>, <span class="st">"blue"</span>, <span class="st">"red"</span>), <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">1</span>)</pre></body></html></div>
<p><img src="maq_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>The blue line (arm 1) plateaus at a spend level of around 0.2, since once we have reached this spend level, we are already giving treatment to all units believed to benefit from arm 1 (i.e. <span class="math inline">\(\hat \tau_1(X_i) &gt; 0\)</span>), and so cannot achieve further gains via increased spending.</p>
<p>Qini curves for single-armed treatment rules can help assessing the value of targeting with a specific arm or targeting function. The multi-armed Qini generalization allows us to answer questions such as “For a specific spend level, what is the estimated increase in gain when optimally targeting with both arms as opposed to using only a single arm?”. Let’s call <span class="math inline">\(\hat Q(B)\)</span> the estimated Qini curve for the multi-armed policy and <span class="math inline">\(\hat Q_2(B)\)</span> the estimated Qini curve for arm 2. At <span class="math inline">\(B = 0.3\)</span>, the difference <span class="math inline">\(\hat Q(B) - \hat Q_2(B)\)</span> (illustrated by the green vertical line in the above plot) is</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/maq/man/difference_gain.html">difference_gain</a></span>(<span class="no">ma.qini</span>, <span class="no">qini.arm2</span>, <span class="kw">spend</span> <span class="kw">=</span> <span class="fl">0.3</span>)
<span class="co">#&gt; estimate  std.err </span>
<span class="co">#&gt;    0.161    0.075</span></pre></body></html></div>
<p>In this example, a multi-armed policy achieves a larger gain than the arm 1 policy by assigning the treatment that is most cost-beneficial to each test set unit (points on arbitrary curves can be compared with this function, yielding paired standard errors that account for the correlation between Qini curves fit on the same test data).</p>
<p>We can also compare different targeting strategies across a range of spend levels. The function <code>integrated_difference</code> estimates an area between two Qini curves. An estimate of the shaded area below (the integral <span class="math inline">\(\int_{0}^{0.3} \left(Q(B) - Q_2(B)\right)dB\)</span>)</p>
<p><img src="maq_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>is given by</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/maq/man/integrated_difference.html">integrated_difference</a></span>(<span class="no">ma.qini</span>, <span class="no">qini.arm2</span>, <span class="kw">spend</span> <span class="kw">=</span> <span class="fl">0.3</span>)
<span class="co">#&gt; estimate  std.err </span>
<span class="co">#&gt;    0.015    0.057</span></pre></body></html></div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>Sverdrup, Erik, Han Wu, Susan Athey, and Stefan Wager. Qini Curves for Multi-Armed Treatment Rules. <em>arXiv preprint arXiv:2306.11979</em> (<a href="https://arxiv.org/abs/2306.11979">arxiv</a>)</p>
<p>Yadlowsky, Steve, Scott Fleming, Nigam Shah, Emma Brunskill, and Stefan Wager. Evaluating Treatment Prioritization Rules via Rank-Weighted Average Treatment Effects. <em>arXiv preprint arXiv:2111.07966</em> (<a href="https://arxiv.org/abs/2111.07966">arxiv</a>)</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>There are many approaches to estimating CATEs in the single-armed setting that can be adopted in the multi-armed case by simply fitting separate CATE functions for the different treatment arms. In this vignette, we use GRF’s <code>multi_arm_causal_forest</code>, which jointly estimates treatment effects for the arms.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>With many treatment arms, this “baseline” arm allocation is going to trace out the upper left convex hull on the “average” cost and <span class="math inline">\(\hat \tau(X_i)\)</span> plane.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>Note that at most one unit will have a non-integer entry in this row matrix. If the particular budget is not enough to give the final <span class="math inline">\(i\)</span>-th unit a treatment, then this unit will either have a single fractional entry, or two fractional entries, depending on whether the unit is being assigned an initial arm or upgraded to a costlier arm. These fractions can be interpreted as a probability of arm assignment.<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Julie Tibshirani, Susan Athey, Erik Sverdrup, Stefan Wager.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
