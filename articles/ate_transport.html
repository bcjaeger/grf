<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estimating ATEs on a new target population • grf</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Estimating ATEs on a new target population">
<meta property="og:description" content="grf">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">grf</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.3.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/grf.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/grf_guide.html">A grf guided tour</a>
    </li>
    <li>
      <a href="../articles/rate.html">Assessing heterogeneity with RATE</a>
    </li>
    <li>
      <a href="../articles/categorical_inputs.html">Categorical covariates</a>
    </li>
    <li>
      <a href="../articles/survival.html">Causal forest with time-to-event data</a>
    </li>
    <li>
      <a href="../articles/ate_transport.html">Estimating ATEs on a new target population</a>
    </li>
    <li>
      <a href="../articles/muhats.html">Estimating conditional means</a>
    </li>
    <li>
      <a href="../articles/diagnostics.html">Evaluating a causal forest fit</a>
    </li>
    <li>
      <a href="../articles/llf.html">Local linear forests</a>
    </li>
    <li>
      <a href="../articles/policy_learning.html">Policy learning via optimal decision trees</a>
    </li>
    <li>
      <a href="../articles/maq.html">Qini curves: Automatic cost-benefit analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="../REFERENCE.html">Algorithm reference</a>
</li>
<li>
  <a href="../DEVELOPING.html">Developing</a>
</li>
<li>
  <a href="../CHANGELOG.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/grf-labs/grf">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="ate_transport_files/header-attrs-2.25/header-attrs.js"></script><script src="ate_transport_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Estimating ATEs on a new target population</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/grf-labs/grf/blob/master/vignettes/ate_transport.Rmd"><code>vignettes/ate_transport.Rmd</code></a></small>
      <div class="hidden name"><code>ate_transport.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">grf</span>)</pre></body></html></div>
<p>This vignette gives a brief overview of how to use GRF to estimate average treatment effects (ATEs) on a new target population defined by some covariates <span class="math inline">\(X_{test}\)</span>. The first part gives a brief overview of the setup and a doubly robust estimator, the second part gives a code example of how to implement the estimator using GRF.</p>
<div id="transport-overview" class="section level2">
<h2 class="hasAnchor">
<a href="#transport-overview" class="anchor"></a>Transport overview</h2>
<p>The general problem of conducting inference on a new target population given estimates from a previous trial, is referred to as a transport problem, and there is a large literature covering the topic. In this vignette we consider the setup and doubly robust estimator proposed in Dahabreh et al. (2020).</p>
<div id="setup" class="section level3">
<h3 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h3>
<p>We define a population indexed by <span class="math inline">\(i = 1 ... n\)</span>. For a subset <span class="math inline">\(RCT\)</span> of this population we have access to results from a randomized/observational trial/study: we have <span class="math inline">\(n_{RCT}\)</span> observations of baseline covariates <span class="math inline">\(X_i\)</span>, binary treatment indicators <span class="math inline">\(W_i=\{0, 1\}\)</span> and responses <span class="math inline">\(Y_i\)</span>. We also have access to the remaining subset <span class="math inline">\(obs\)</span> where we only observe <span class="math inline">\(n_{obs}\)</span> observations (<span class="math inline">\(n_{RCT} + n_{obs}=n\)</span>) of the baseline covariates <span class="math inline">\(X_i\)</span>. We say the first subset participated in a trail, and that <span class="math inline">\(S_i = 1\)</span>, and the second did not: <span class="math inline">\(S_i = 0\)</span>. We are interested in the average treatment effect among the non-participants (the “target” population), that is:</p>
<p><span class="math display">\[E[Y(1) - Y(0) | S = 0],\]</span></p>
<p>where <span class="math inline">\(Y(1), Y(0)\)</span> are potential outcomes corresponding to the two treatment states.</p>
<p>In general, this average is not equal to the ATE among trial participants, <span class="math inline">\(E[Y(1) - Y(0) | S = 1]\)</span>, since the distribution of treatment effect modifiers may be different among trial participants and non-participants.</p>
<p>The following table illustrates the setup:</p>
<table class="table">
<thead><tr class="header">
<th>Population</th>
<th>Unit</th>
<th>S</th>
<th>X</th>
<th>Y</th>
<th>W</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>trial population</td>
<td>1</td>
<td>1</td>
<td><span class="math inline">\(X_1\)</span></td>
<td><span class="math inline">\(Y_1\)</span></td>
<td><span class="math inline">\(W_1\)</span></td>
</tr>
<tr class="even">
<td>trial population</td>
<td>…</td>
<td>1</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>trial population</td>
<td><span class="math inline">\(n_{RCT}\)</span></td>
<td>1</td>
<td><span class="math inline">\(X_{n_{RCT}}\)</span></td>
<td><span class="math inline">\(Y_{n_{RCT}}\)</span></td>
<td><span class="math inline">\(W_{n_{RCT}}\)</span></td>
</tr>
<tr class="even">
<td>target population</td>
<td>
<span class="math inline">\(n_{RCT}\)</span> + 1</td>
<td>0</td>
<td><span class="math inline">\(X_{n_{RCT}+1}\)</span></td>
<td>?</td>
<td>?</td>
</tr>
<tr class="odd">
<td>target population</td>
<td>…</td>
<td>0</td>
<td></td>
<td>?</td>
<td>?</td>
</tr>
<tr class="even">
<td>target population</td>
<td><span class="math inline">\(n_{RCT} + n_{obs}\)</span></td>
<td>0</td>
<td><span class="math inline">\(X_{n_{RCT}+n_{obs}}\)</span></td>
<td>?</td>
<td>?</td>
</tr>
</tbody>
</table>
</div>
<div id="assumptions" class="section level3">
<h3 class="hasAnchor">
<a href="#assumptions" class="anchor"></a>Assumptions</h3>
<p>Estimating <span class="math inline">\(E[Y(1) - Y(0) | S = 0]\)</span> given estimates of <span class="math inline">\(E[Y(1) - Y(0) | S = 1]\)</span> requires two assumptions beyond the standard identify assumptions for causal inference in observational/randomized trials:</p>
<ol style="list-style-type: decimal">
<li><p><em>Conditional exchangeability in mean over S</em>. The potential outcome mean is independent of trial participation conditional on baseline covariates: <span class="math inline">\(E[Y(W) | X = x, S = 1] = E[Y(W) | X = x, S = 0]\)</span>.</p></li>
<li><p><em>Positivity of trial participation</em>. The probability of participating in the trail, conditional on the covariates needed to ensure exchangeability, is positive: <span class="math inline">\(P[S = 1 | X = x] &gt; 0\)</span>.</p></li>
</ol>
<p>Condition 1 is known as the <em>transport condition</em> and is important, but untestable. Condition 2 essentially states that all covariate patterns in the target population should be present in the target population, and the plausibility of this can be gauged by inspecting the estimates of <span class="math inline">\(P[S = 1 | X = x] &gt; 0\)</span>.</p>
</div>
<div id="estimator" class="section level3">
<h3 class="hasAnchor">
<a href="#estimator" class="anchor"></a>Estimator</h3>
<p>Some definitions first. <span class="math inline">\(\hat \tau^{(-i)}(X_i)\)</span> are estimates of the conditional average treatment effects <span class="math inline">\(E[Y_i(1) - Y_i(0) | X_i = x]\)</span>. <span class="math inline">\(\hat p^{(-i)}(X_i)\)</span> are estimates of the conditional trial-inclusion probabilities <span class="math inline">\(P[S = 1 | X_i = x]\)</span>. <span class="math inline">\(\hat e^{(-i)}(X_i)\)</span> are estimates of the treatment propensities <span class="math inline">\(E[W_i | X_i = x]\)</span> and <span class="math inline">\(\mu^{(-i)}(X_i, W_i)\)</span> are estimates of the conditional responses <span class="math inline">\(E[Y_i | W_i = w, X_i = x]\)</span>. The superscript (-1) indicates cross-fitting, i.e. the estimate for unit <span class="math inline">\(i\)</span> is obtained without using unit <span class="math inline">\(i\)</span> for estimation. <span class="math inline">\(n_{RCT}\)</span> is the number of units participating in the trial, and <span class="math inline">\(n_{obs}\)</span> is the number of units in the target population.</p>
<p>A doubly robust estimate of the ATE on the target population is:</p>
<p><span class="math display">\[\begin{equation}
\begin{split}
&amp; \hat \tau_{target} =
  \frac{1}{n_{obs}}
  \sum_{i \in obs} \hat \tau^{(-i)}(X_i) + \\ &amp;

  \frac{1}{n_{obs}}
  \sum_{i \in RCT}
  \left(\frac{1 - \hat p^{(-i)}(X_i)}{\hat p^{(-i)}(X_i)}\right)
  \left(\frac{W_i - \hat e^{(-i)}(X_i)}{\hat e^{(-i)}(X_i)(1-\hat e^{(-i)}(X_i))}\right)
  \left(Y_i - \hat \mu^{(-i)}(X_i, W_i) \right).
\end{split}
\end{equation}\]</span></p>
<p>This is equation (4) in Dahabreh et al. (2020) written on contrast form. All the quantities needed for this estimator are easily obtained with GRF. The main difference from the traditional doubly robust ATE estimator among trial participants is the presence of the transport probabilities <span class="math inline">\(\hat p^{(-i)}(X_i)\)</span>, which makes an appearance as an inverse odds term. The quantity <span class="math inline">\(\mu^{(-i)}(X_i, W_i)\)</span> can be constructed from a causal forest fit, see <a href="https://grf-labs.github.io/grf/articles/muhats.html">this vignette</a> for details. We can also use this construction for standard error estimates. In general doubly robust estimators respect an oracle property w.r.t the nuisance components, meaning we can use plug-in estimates in place of the true values and retain some first-order equivalence and compute the variance of this expression directly (which in this case reduces to a sum of two independent terms).</p>
</div>
</div>
<div id="algorithm" class="section level2">
<h2 class="hasAnchor">
<a href="#algorithm" class="anchor"></a>Algorithm</h2>
<p>The following function implements this estimator, taking as argument an ordinary causal forest (or causal survival forest) trained with a binary treatment.</p>
<p><strong><em>Input</em></strong>:</p>
<ol style="list-style-type: decimal">
<li>
<code>forest</code>: a trained causal forest.</li>
<li>
<code>X.test</code>: a covariate matrix <span class="math inline">\(X\)</span> to compute the ATE on.</li>
<li>
<code>p.hat</code>: optional estimates of the trial inclusion probabilities <span class="math inline">\(P[S = 1 | X = x]\)</span> for the trial participating units. If these are not provided they are estimated with a regression forest.</li>
</ol>
<p><strong><em>Output</em></strong>: A doubly robust estimate of the ATE on the test set, along with standard errors.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">average_treatment_effect_test</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">forest</span>, <span class="no">X.test</span>, <span class="no">p.hat</span> <span class="kw">=</span> <span class="kw">NULL</span>) {
  <span class="no">Y.hat</span> <span class="kw">&lt;-</span> <span class="no">forest</span>$<span class="no">Y.hat</span>
  <span class="no">Y.orig</span> <span class="kw">&lt;-</span> <span class="no">forest</span>$<span class="no">Y.orig</span>
  <span class="no">W.hat</span> <span class="kw">&lt;-</span> <span class="no">forest</span>$<span class="no">W.hat</span>
  <span class="no">W.orig</span> <span class="kw">&lt;-</span> <span class="no">forest</span>$<span class="no">W.orig</span>
  <span class="no">n.rct</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">Y.orig</span>)
  <span class="no">n.obs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">X.test</span>)

  <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="no">p.hat</span>)) {
    <span class="no">S.forest</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/regression_forest.html">regression_forest</a></span>(<span class="kw">X</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="no">forest</span>$<span class="no">X.orig</span>, <span class="no">X.test</span>),
                                  <span class="kw">Y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>, <span class="no">n.rct</span>), <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="no">n.obs</span>)),
                                  <span class="kw">num.trees</span> <span class="kw">=</span> <span class="fl">500</span>)
    <span class="no">p.hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">S.forest</span>)$<span class="no">predictions</span>[<span class="fl">1</span>:<span class="no">n.rct</span>]
  }

  <span class="no">tau.hat.test</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">forest</span>, <span class="no">X.test</span>)$<span class="no">predictions</span>
  <span class="no">tau.hat.train</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">forest</span>)$<span class="no">predictions</span>
  <span class="no">debiasing.weights</span> <span class="kw">&lt;-</span> (<span class="fl">1</span> - <span class="no">p.hat</span>) / <span class="no">p.hat</span> * (<span class="no">W.orig</span> - <span class="no">W.hat</span>) / (<span class="no">W.hat</span> * (<span class="fl">1</span> - <span class="no">W.hat</span>))
  <span class="no">Y.residual</span> <span class="kw">&lt;-</span> <span class="no">Y.orig</span> - (<span class="no">Y.hat</span> + <span class="no">tau.hat.train</span> * (<span class="no">W.orig</span> - <span class="no">W.hat</span>))

  <span class="no">tau.hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">tau.hat.test</span>) + <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">debiasing.weights</span> * <span class="no">Y.residual</span>) / <span class="no">n.obs</span>
  <span class="no">sigma2.hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span>(<span class="no">tau.hat.test</span>) / <span class="no">n.obs</span> + <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">Y.residual</span>^<span class="fl">2</span> * (<span class="no">debiasing.weights</span> / <span class="no">n.obs</span>)^<span class="fl">2</span>)

  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">estimate</span> <span class="kw">=</span> <span class="no">tau.hat</span>, <span class="kw">std.err</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">sigma2.hat</span>))
}</pre></body></html></div>
<p>Note the estimator involves division by the transport probabilities <span class="math inline">\(\hat p^{(-i)}(X_i)\)</span>, which will be a problem if too small. In general it is a good idea to plot the histogram of these estimates to asses if there is a positivity issue.</p>
</div>
<div id="an-example" class="section level2">
<h2 class="hasAnchor">
<a href="#an-example" class="anchor"></a>An example</h2>
<p>In this section we simulate a simple example where the distribution of treatment effect modifiers (<span class="math inline">\(X_1\)</span>) are different in the randomized trial and target population (i.e., the trial inclusion probability depends on an effect modifier). Plotting the simulated potential outcomes, the two distributions look like:</p>
<p><img src="ate_transport_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>The blue distribution is the target population we want an ATE for. The red distribution is the RCT we have access to. The dashed lines indicate the means. Below we simulate a draw from this setup, then estimate the target ATE and compute a 95% confidence interval, as well as compare it with the “naive” approach of just averaging predictions on a test set.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">2000</span>
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fl">5</span>
<span class="no">X.population</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span> * <span class="no">p</span>), <span class="no">n</span>, <span class="no">p</span>)
<span class="no">trial.inclusion.prob</span> <span class="kw">&lt;-</span> <span class="fl">1</span> / (<span class="fl">1</span> + <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(-<span class="no">X.population</span>[, <span class="fl">1</span>] / <span class="fl">2</span>))
<span class="no">S</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="no">n</span>, <span class="fl">1</span>, <span class="no">trial.inclusion.prob</span>)

<span class="no">X.test</span> <span class="kw">&lt;-</span> <span class="no">X.population</span>[<span class="no">S</span> <span class="kw">==</span> <span class="fl">0</span>, ]

<span class="no">X</span> <span class="kw">&lt;-</span> <span class="no">X.population</span>[<span class="no">S</span> <span class="kw">==</span> <span class="fl">1</span>, ]
<span class="no">W</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">X</span>), <span class="fl">1</span>, <span class="fl">0.5</span>)
<span class="no">tau</span> <span class="kw">&lt;-</span> <span class="no">X</span>[, <span class="fl">1</span>] + <span class="fl">1</span>
<span class="no">Y</span> <span class="kw">&lt;-</span> <span class="no">X</span>[, <span class="fl">2</span>] + <span class="no">tau</span> * <span class="no">W</span> + <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">X</span>))

<span class="no">forest</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/causal_forest.html">causal_forest</a></span>(<span class="no">X</span>, <span class="no">Y</span>, <span class="no">W</span>, <span class="kw">W.hat</span> <span class="kw">=</span> <span class="fl">0.5</span>)
<span class="no">ate.test</span> <span class="kw">&lt;-</span> <span class="fu">average_treatment_effect_test</span>(<span class="no">forest</span>, <span class="no">X.test</span>)
<span class="no">estimate</span> <span class="kw">&lt;-</span> <span class="no">ate.test</span>[<span class="fl">1</span>]
<span class="no">std.err</span> <span class="kw">&lt;-</span> <span class="no">ate.test</span>[<span class="fl">2</span>]

<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"Estimate: %1.2f"</span>, <span class="no">estimate</span>)
<span class="co">#&gt; [1] "Estimate: 0.81"</span>
<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"95%% CI: (%1.2f, %1.2f)"</span>, <span class="no">estimate</span> - <span class="fl">1.96</span> * <span class="no">std.err</span>, <span class="no">estimate</span> + <span class="fl">1.96</span> * <span class="no">std.err</span>)
<span class="co">#&gt; [1] "95% CI: (0.65, 0.96)"</span>
<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"Naive estimate: %1.2f"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">forest</span>, <span class="no">X.test</span>)$<span class="no">predictions</span>))
<span class="co">#&gt; [1] "Naive estimate: 0.86"</span>
<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"True mean: %1.2f"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">X.test</span>[, <span class="fl">1</span>] + <span class="fl">1</span>))
<span class="co">#&gt; [1] "True mean: 0.78"</span></pre></body></html></div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>Dahabreh, Issa J., Sarah E. Robertson, Jon A. Steingrimsson, Elizabeth A. Stuart, and Miguel A. Hernan. Extending inferences from a randomized trial to a new target population. Statistics in Medicine 39(14), 2020. (<a href="https://onlinelibrary.wiley.com/doi/10.1002/sim.8426">paper</a>)</p>
</div>
<div id="appendix-estimating-ey-x-test" class="section level2">
<h2 class="hasAnchor">
<a href="#appendix-estimating-ey-x-test" class="anchor"></a>Appendix: estimating E[Y | X.test]</h2>
<p>The case where we just want an estimate of the conditional mean <span class="math inline">\(E[Y | X_{test}]\)</span> can also be derived as a special case of the transport routine described above. There is however a simpler way to achieve this using just a plain causal forest with a dummy treatment indicator: denote the original training data by <span class="math inline">\((X_{train}, Y_{train})\)</span> and the new test data by <span class="math inline">\(X_{test}\)</span>. Augment the data the following way with a dummy treatment and response variable <span class="math inline">\((X, Y, W)\)</span>: <span class="math inline">\((X_{train}, Y_{train}, 1)\)</span> and <span class="math inline">\((X_{test}, 0, 0)\)</span>. Then the average treatment effect on controls (ATC) from a causal forest fit on this augmented data will give an estimate of <span class="math inline">\(E[Y | X_{test}]\)</span>: since we “defined” the potential outcomes to be <span class="math inline">\(Y(1) = Y\)</span> and <span class="math inline">\(Y(0) = 0\)</span>, we have that <span class="math inline">\(E[Y(1) - Y(0) | X_{test}] = E[Y | X_{test}]\)</span>.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">2000</span>
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fl">5</span>
<span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span> * <span class="no">p</span>), <span class="no">n</span>, <span class="no">p</span>)
<span class="no">S.hat</span> <span class="kw">&lt;-</span> <span class="fl">1</span> / (<span class="fl">1</span> + <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(-<span class="no">X</span>[, <span class="fl">1</span>] / <span class="fl">2</span>))
<span class="no">S</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="no">n</span>, <span class="fl">1</span>, <span class="no">S.hat</span>)
<span class="no">Y</span> <span class="kw">&lt;-</span> <span class="fl">1</span> + <span class="no">X</span>[, <span class="fl">1</span>] + <span class="no">X</span>[, <span class="fl">2</span>] + <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span>)

<span class="no">X.train</span> <span class="kw">&lt;-</span> <span class="no">X</span>[<span class="no">S</span> <span class="kw">==</span> <span class="fl">1</span>, ]
<span class="no">Y.train</span> <span class="kw">&lt;-</span> <span class="no">Y</span>[<span class="no">S</span> <span class="kw">==</span> <span class="fl">1</span>]
<span class="no">X.test</span> <span class="kw">&lt;-</span> <span class="no">X</span>[<span class="no">S</span> <span class="kw">==</span> <span class="fl">0</span>, ]

<span class="no">X.aug</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="no">X.train</span>, <span class="no">X.test</span>)
<span class="no">Y.aug</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">Y.train</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">X.test</span>)))
<span class="no">W.aug</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">X.train</span>)), <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">X.test</span>)))
<span class="no">cf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/causal_forest.html">causal_forest</a></span>(<span class="no">X.aug</span>, <span class="no">Y.aug</span>, <span class="no">W.aug</span>, <span class="kw">num.trees</span> <span class="kw">=</span> <span class="fl">500</span>)

<span class="no">ate</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/average_treatment_effect.html">average_treatment_effect</a></span>(<span class="no">cf</span>, <span class="kw">target.sample</span> <span class="kw">=</span> <span class="st">"control"</span>)
<span class="no">estimate</span> <span class="kw">&lt;-</span> <span class="no">ate</span>[<span class="fl">1</span>]
<span class="no">std.err</span> <span class="kw">&lt;-</span> <span class="no">ate</span>[<span class="fl">2</span>]

<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"Estimate: %1.2f"</span>, <span class="no">estimate</span>)
<span class="co">#&gt; [1] "Estimate: 0.73"</span>
<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"95%% CI: (%1.2f, %1.2f)"</span>, <span class="no">estimate</span> - <span class="fl">1.96</span> * <span class="no">std.err</span>, <span class="no">estimate</span> + <span class="fl">1.96</span> * <span class="no">std.err</span>)
<span class="co">#&gt; [1] "95% CI: (0.63, 0.83)"</span>
<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"True mean: %1.2f"</span>,  <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">Y</span>[<span class="no">S</span> <span class="kw">==</span> <span class="fl">0</span>]))
<span class="co">#&gt; [1] "True mean: 0.79"</span></pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Julie Tibshirani, Susan Athey, Erik Sverdrup, Stefan Wager.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
